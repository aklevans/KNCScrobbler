<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head> 
    <title>KNC Scrobbler</title> 
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <style>
		.center {
 			margin: auto;
		  width: 50%;
		  padding: 150px;
		  text-align: center;
		  font-family: sans-serif;
		}
	</style>
</head>
<script
	src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.js"></script>
<body style="background-color:aquamarine">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/core.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/md5.js"></script>
	

	
	
	<div class="center">
		<b style="font-size: 30px;">KNC Scrobbler!</b>
		<br/>
		<br/>
		<img id="cover">
		<br/>
		
		<iframe src="src/main/resources/250-milliseconds-of-silence.mp3" allow="autoplay" id="audio" style="display: none"></iframe>
		<audio controls autoplay name="media">
			<source src="https://ais-edge105-live365-dal02.cdnstream.com/a45877" type="audio/mpeg"> == $0
		</audio>
		<br/>
		<br/>
		<b id="songname"></b>
		<p id="artist"></p>
		<button id=lb type="button" onclick="linkAccount()">Link last.fm Account </button>
		<p id="linked" style="color:gray"></p>
		<button id=reset type="button" onclick="reset()">Unlink account</button>


	</div>
	
		<script>
		// api url
		const api_url_1 = 
			  "https://wknc.org/wp-json/wknc/v1/now-playing?station=1";
			  
		const api_url_2 = 
			  "https://wknc.org/wp-json/wknc/v1/now-playing?station=2";
			  
		const api_key = "23a4290148e4069d3dbce24cade6b491";
		
		// idk if i can legally use this image
		//const default_image = "https://wknc.org/wp-content/uploads/2020/10/wknc881-bow.jpg";
		
		const default_image = "https://github.com/aklevans/KNCScrobbler/blob/main/KNCScrobbler/src/main/resources/images/white%20square%201.png?raw=true";
		
		var api_url = api_url_1;
		
		async function main(){
			var session;
			session = await startSession();
			update(session, 0);
			setInterval(function() {update(session, 55000); }, 60000);
		}
		
		main();

		
		
		
		
		// Defining async function
		async function getCurrentSong() {
		   
			// Storing response
			const response = await fetch(api_url);
		   
			// Storing data in form of JSON
			var data = await response.json();
			//console.log(data);

			//show(data);
			return data;
		}
		
		function changeChannel(channel){
			if(chanel === "HD1"){
				api_url = api_url_1;
			}
			else api_url = api_url_2;
			
		}
		
		
		async function setAlbumCover(songdata) {
			let response = await fetch("http://ws.audioscrobbler.com/2.0/?method=track.getInfo&api_key=" + api_key + "&artist=" + songdata.artist + "&track=" + songdata.song + "&format=json");
			var dat = await response.json();
			console.log(dat);
			//JSON.parse(dat.track.album.image)[2].text
			var propertyName = '#text'
			//url = dat.track.album.image[3][propertyName];
			//console.log(url);
			//console.log(dat.track.album.image[0][propertyName]);
			//console.log(dat.track.album.image[2].#text);
			
			try{
				url = dat.track.album.image[3][propertyName];
				console.log(url.length);
				if( url === null || url.length === 0){
					document.getElementById("cover").src = default_image;
				}
				document.getElementById("cover").src = url;
				console.log(url);
			} catch( err ){
				document.getElementById("cover").src = default_image;
			}

		}


		async function scrobbleSong(data, session){
			
			var combined = Object.assign({}, data, session);
			var combinedString = JSON.stringify(combined)
			const options = {
				method: "POST",
				body: combinedString
			}
			//console.log("songData: " + combinedString);
			let response = await fetch("api/song/", options);
			//console.log(response);
		}

		
		async function update(session, delay){
			const queryString = window.location.search;
			const urlParams = new URLSearchParams(queryString);
			var songData = await getCurrentSong();
			//console.log(songData);
						
			setTimeout(function() {}, delay);
			

			var lastName = document.getElementById("songname").innerText;
			var lastArtist = document.getElementById("artist").innerText;
			if((songData.song !== document.getElementById("songname").innerText || songData.artist !== document.getElementById("artist").innerText) &&  session != null) {
				//account for stream lagging behind spinitron

				scrobbleSong(songData, session);
				console.log("scrobble");
				//show(songData);
			}
			
			
			
			show(songData);
			setAlbumCover(songData);

		}
		

		
		async function startSession(){
			document.getElementById("reset").style.display="none";
			
			const queryString = window.location.search;
			const urlParams = new URLSearchParams(queryString);
			const token = urlParams.get('token');
			window.history.replaceState({}, document.title, "/");

			if(document.cookie != null && document.cookie != "" && document.cookie != "null") {
				var cookie = JSON.parse(document.cookie);
				document.getElementById("lb").style.display="none";
				document.getElementById("linked").innerHTML = cookie.username + "'s account linked!";
				document.getElementById("reset").style.display="inline";

				//console.log(document.cookie);
				return cookie;
			}
			else if(token != null){
				let response = await fetch("api/token/" + token);
				console.log(response);
				a = await response.text();
				//console.log(a);
				j = JSON.parse(a);
				//console.log(j);
				document.getElementById("lb").style.display="none";
				document.getElementById("linked").innerHTML = j.username + "'s account linked!";
				document.getElementById("reset").style.display="inline";
				document.cookie = JSON.stringify(j);

				return j;
			}
			return null;
		}
		
		
		function show(data) {				
			document.getElementById("songname").innerText = data.song;
			document.getElementById("artist").innerText = data.artist;
		}
		
		function linkAccount(){
			
			window.open("http://www.last.fm/api/auth/?api_key=" + api_key + "&cb=" + window.location.href, '_self');
		}
		
		function reset(){
			document.cookie = null;
			document.getElementById("lb").style.display="inline";
			document.getElementById("linked").innerText = "";
			document.getElementById("reset").style.display="none";
			



		}
		
	</script>
	
</body>
</html>